name: CI - Build Docker Image

on:
  push:
    branches:
      - '**'
    paths:
      - 'app/**'
      - 'app/Dockerfile'
  pull_request:
    paths:
      - 'app/**'
      - 'app/Dockerfile'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch full history for git tag detection

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Determine Docker image tag
      id: tag
      run: |
        # Default to commit SHA tag
        IMAGE_TAG="${GITHUB_SHA}"
        
        # If on main branch, use the latest Git tag as semantic version
        if [ "${GITHUB_REF##refs/heads/}" = "main" ]; then
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          IMAGE_TAG="${LATEST_TAG}"
        fi

        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Build Docker image
      run: |
        IMAGE_NAME=sre_challenge_app
        docker build -t $IMAGE_NAME:${{ steps.tag.outputs.image_tag }} app/

    # No push step here to avoid needing credentials in public repo

#optional steps - depends your docker implementation - macos colima
# colima start
# docker context use default
# docker info


#Build steps - Requirements for local deployment testing
# cd app/ 
# docker build -t sre_challenge_app:v1.0.0 .